# 高质量翻译实现文档

## 概述

高质量翻译是一个三阶段的翻译流程，通过分离预处理、批量翻译和渲染过程，为AI翻译器提供更多上下文信息，从而获得更准确的翻译结果。

## 核心设计理念

1. **三阶段处理**: 预处理获取文本 → 批量翻译 → 连续渲染
2. **上下文增强**: 向AI提供文本框顺序、原文和原图信息
3. **自动触发**: 使用特定翻译器时自动启用高质量模式
4. **配置继承**: 完全使用用户的所有配置（OCR、检测器、渲染器等）

## 文件结构

### 1. 配置文件 (manga_translator/config.py)

```python
class Translator(str, Enum):
    # ... 其他翻译器
    openai_hq = "openai_hq"      # OpenAI高质量翻译器
    gemini_hq = "gemini_hq"      # Gemini高质量翻译器
    # ...

class Config(BaseModel):
    # ...
    high_quality_batch_size: int = 3  # 高质量翻译批次大小
    # ...
```

### 2. OpenAI高质量翻译器 (manga_translator/translators/openai_hq.py)

**环境变量复用**:
- `OPENAI_API_KEY`: API密钥
- `OPENAI_API_BASE`: API基础URL
- `OPENAI_MODEL`: 使用的模型

**核心功能**:
- `_translate_batch_high_quality()`: 批量高质量翻译
- `_build_system_prompt()`: 构建系统提示词
- `_build_user_prompt()`: 构建用户提示词，包含图片和文本信息
- `encode_image_for_openai()`: 图片编码处理

**翻译流程**:
1. 接收批量数据（图片、文本框顺序、原文）
2. 构建包含多图片上下文的提示词
3. 发送给OpenAI API进行批量翻译
4. 解析并返回翻译结果

### 3. Gemini高质量翻译器 (manga_translator/translators/gemini_hq.py)

**环境变量复用**:
- `GEMINI_API_KEY`: API密钥
- `GEMINI_API_BASE`: API基础URL
- `GEMINI_MODEL`: 使用的模型

**核心功能**:
- `_translate_batch_high_quality()`: 批量高质量翻译
- `_build_system_prompt()`: 构建系统提示词
- `_build_user_prompt()`: 构建用户提示词
- `encode_image_for_gemini()`: 图片编码处理

**翻译流程**:
1. 接收批量数据
2. 构建多模态内容（文本 + 图片）
3. 发送给Gemini API
4. 解析返回结果

### 4. 翻译器注册 (manga_translator/translators/__init__.py)

```python
GPT_TRANSLATORS = {
    # ... 其他翻译器
    'openai_hq': 'manga_translator.translators.openai_hq:OpenAIHighQualityTranslator',
    'gemini_hq': 'manga_translator.translators.gemini_hq:GeminiHighQualityTranslator',
}
```

### 5. 主翻译逻辑 (manga_translator/manga_translator.py)

#### 自动检测逻辑 (translate_batch方法, 行1837-1845)

```python
# 检查是否使用高质量翻译器，如果是则自动启用高质量模式
if images_with_configs:
    first_config = images_with_configs[0][1] if images_with_configs else None
    if first_config and hasattr(first_config.translator, 'translator'):
        from ..config import Translator
        translator_type = first_config.translator.translator
        if translator_type in [Translator.openai_hq, Translator.gemini_hq]:
            logger.info(f"检测到高质量翻译器 {translator_type}，自动启用高质量翻译模式")
            return await self._translate_batch_high_quality(images_with_configs)
```

#### 高质量翻译主流程 (_translate_batch_high_quality方法, 行3189-3356)

**阶段一: 预处理阶段 (行3197-3225)**
```python
# 阶段一：预处理阶段 - 获取所有图片的文本区域
logger.info("Phase 1: Pre-processing all images (detection + OCR)")
preprocessed_contexts = []

for i, (image, config) in enumerate(images_with_configs):
    # 设置图片上下文
    self._set_image_context(config, image)
    # 执行到翻译前的所有步骤
    ctx = await self._translate_until_translation(image, config)
    # 保存图片名称用于后续文件保存
    if hasattr(image, 'name'):
        ctx.image_name = image.name
    preprocessed_contexts.append((ctx, config))
```

**阶段二: 批量翻译阶段 (行3227-3311)**
```python
# 阶段二：批量翻译阶段
batch_size = getattr(self, 'high_quality_batch_size', 3)
logger.info(f"Phase 2: Batch translation with batch size: {batch_size}")

# 按高质量批次大小分组处理
for batch_start in range(0, len(preprocessed_contexts), batch_size):
    # 准备批量翻译数据：文本框顺序、原文、原图
    batch_data = []
    for ctx_idx, (ctx, config) in enumerate(current_batch):
        image_data = {
            'image': ctx.input,
            'text_regions': ctx.text_regions if ctx.text_regions else [],
            'original_texts': [region.text for region in ctx.text_regions] if ctx.text_regions else [],
            'text_order': list(range(len(ctx.text_regions))) if ctx.text_regions else []
        }
        batch_data.append(image_data)
    
    # 创建增强的context，包含批次信息
    enhanced_ctx = current_batch[0][0] if current_batch else Context()
    enhanced_ctx.high_quality_batch_data = batch_data
    enhanced_ctx.high_quality_batch_size = len(current_batch)
    
    # 调用高质量翻译器
    translated_texts = await self._batch_translate_texts(all_texts, sample_config, enhanced_ctx)
```

**阶段三: 连续渲染阶段 (行3313-3340)**
```python
# 阶段三：连续渲染阶段
logger.info(f"Phase 3: Continuous rendering for {len(translated_contexts)} images")

for i, (ctx, config) in enumerate(translated_contexts):
    # 恢复图片上下文用于调试文件保存
    if hasattr(ctx, 'input'):
        from .utils.generic import get_image_md5
        image_md5 = get_image_md5(ctx.input)
        if not self._restore_image_context(image_md5):
            self._set_image_context(config, ctx.input)
    
    # 完成翻译管道的剩余部分（掩码、修复、渲染）
    ctx = await self._complete_translation_pipeline(ctx, config)
    
    # 保存翻译结果文件
    if ctx.text_regions and hasattr(ctx, 'image_name') and ctx.image_name:
        self._save_text_to_file(ctx.image_name, ctx)
```

#### 批量翻译文本支持 (_batch_translate_texts方法, 行2600-2735)

```python
# 如果是ChatGPT翻译器或高质量翻译器，需要处理上下文
if config.translator.translator in [Translator.chatgpt, Translator.chatgpt_2stage, Translator.openai_hq, Translator.gemini_hq]:
    if config.translator.translator == Translator.openai_hq:
        from .translators.openai_hq import OpenAIHighQualityTranslator
        translator = OpenAIHighQualityTranslator()
    elif config.translator.translator == Translator.gemini_hq:
        from .translators.gemini_hq import GeminiHighQualityTranslator
        translator = GeminiHighQualityTranslator()
```

### 6. UI集成 (desktop-ui/app.py)

#### 环境变量映射
```python
translator_env_vars = {
    # ... 其他翻译器
    'openai_hq': ['OPENAI_API_KEY', 'OPENAI_API_BASE', 'OPENAI_MODEL'],
    'gemini_hq': ['GEMINI_API_KEY', 'GEMINI_API_BASE', 'GEMINI_MODEL'],
}
```

#### 显示名称映射
```python
translator_display_names = {
    # ... 其他翻译器
    'openai_hq': '高质量翻译 OpenAI',
    'gemini_hq': '高质量翻译 Gemini',
}

# 反向映射
reverse_translator_display_names = {v: k for k, v in translator_display_names.items()}
```

### 7. 配置示例 (examples/config-example.json)

```json
{
  "cli": {
    "high_quality_batch_size": 3
  }
}
```

## 工作流程详解

### 触发条件
- 使用 `openai_hq` 或 `gemini_hq` 翻译器时自动触发
- 无需额外开关，根据翻译器类型自动判断

### 数据流转

1. **输入**: `List[tuple(Image, Config)]` - 图片和配置对列表
2. **阶段一输出**: `List[tuple(Context, Config)]` - 包含文本区域的上下文
3. **阶段二输出**: `List[tuple(Context, Config)]` - 包含翻译结果的上下文
4. **最终输出**: `List[Context]` - 完整的翻译结果

### 批次处理
- 预处理：逐个处理所有图片
- 翻译：按 `high_quality_batch_size` 分批处理
- 渲染：逐个处理所有图片

### 错误处理
- 各阶段都有异常捕获和降级处理
- 失败时返回原文或空翻译
- 保持处理流程的连续性

## 技术特点

### 上下文增强
- 提供多张图片的完整上下文
- 包含文本框的空间顺序信息
- 结合视觉信息进行翻译

### 配置继承
- 完全使用用户配置的OCR设置
- 使用用户配置的检测器设置
- 使用用户配置的渲染器设置
- 使用用户配置的其他所有参数

### 内存优化
- 分阶段处理避免内存峰值
- 及时清理中间结果
- 支持大批量图片处理

### 并发安全
- 图片上下文隔离
- 路径管理独立
- 状态保存和恢复

## 使用方式

### 通过UI
1. 选择 "高质量翻译 OpenAI" 或 "高质量翻译 Gemini"
2. 设置对应的环境变量
3. 配置 `high_quality_batch_size` 参数
4. 正常执行翻译任务

### 通过配置文件
```json
{
  "translator": {
    "translator": "openai_hq",
    "target_lang": "CHS"
  },
  "cli": {
    "high_quality_batch_size": 5
  }
}
```

### 环境变量设置
```bash
# OpenAI高质量翻译
export OPENAI_API_KEY="your-api-key"
export OPENAI_API_BASE="https://api.openai.com/v1"
export OPENAI_MODEL="gpt-4o"

# Gemini高质量翻译
export GEMINI_API_KEY="your-api-key" 
export GEMINI_API_BASE="https://generativelanguage.googleapis.com"
export GEMINI_MODEL="gemini-1.5-flash"
```

## 优势

1. **翻译质量提升**: 通过提供完整上下文信息
2. **批量效率**: 减少API调用次数
3. **配置兼容**: 完全兼容现有配置系统
4. **自动化**: 无需手动开关，根据翻译器自动判断
5. **错误恢复**: 完善的错误处理和降级机制