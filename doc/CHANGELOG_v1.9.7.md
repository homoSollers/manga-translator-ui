# v1.9.7 更新日志

发布日期：2025-12-21

## ⚡ 优化

### MangaJaNai 超分彩图检测
- **改进彩图检测算法**：使用 RGB 通道相关性作为主要判断依据，结合饱和度、标准差差异三个指标综合判断，准确率 100%（经 204 张图片测试验证）

### 调试日志增强
- **添加详细调试日志**：在导出、加载 JSON 和超分倍率缩放时添加数据类型和值的详细日志，便于诊断类型错误

### 并发流水线错误处理
- **改进错误传播机制**：当任一线程（检测+OCR、翻译、修复、渲染）出错时，立即停止所有其他线程，避免资源浪费
- **优化错误堆栈显示**：保留原始异常对象并重新抛出，确保完整的异常链传递到上层，便于问题诊断
- **精简日志输出**：去掉冗余的任务完成日志，只保留关键错误信息

## 🐛 修复

### 渲染性能
- **修复断句优化算法卡顿**：采用分层策略替代暴力枚举，27个断句从1.34亿种组合降至约24种，从卡死到秒级完成

### 翻译错误
- **修复空文本导致的 AttributeError**：在多处添加 None 检查和空文本过滤

### 文件排序
- **修复自然排序类型比较错误**：优化 `_natural_sort_key` 方法使用元组确保类型安全

### 超分倍率解析
- **支持多种超分倍率格式**：支持数字、字符串、MangaJaNai、RealCUGAN 等多种格式，新增 `parse_upscale_ratio` 辅助函数统一处理

### 线程池清理
- **改进线程池清理机制**：为缩略图加载线程池添加 shutdown 函数，防止资源泄漏

### API响应验证
- **新增统一的 API 响应验证**：应用到 5 个翻译器，防止无效响应对象导致的错误
- **修复 text_regions 类型错误**：确保始终为列表类型，添加类型检查
- **检测器输入验证增强**：在 DefaultDetector 和 YOLOOBBDetector 中添加多层验证，防止 OpenCV resize 断言失败
- **图片加载验证**：在多个关键位置验证图片有效性，防止空图片或无效尺寸导致崩溃

### 日志系统
- **文件日志始终记录 DEBUG 级别**：便于问题排查，控制台日志根据配置调整
