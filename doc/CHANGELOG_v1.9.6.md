# v1.9.6 更新日志

发布日期：2025-12-20

## ✨ 新功能

### 术语提取与管理
- **新增自动提取新术语功能 (Auto Extract Glossary)**：OpenAI 和 Gemini 翻译器现在可以自动识别原文中的专有名词（人名、地名、技能等），并将其添加到自定义提示词文件中。
- **配置开关**：在“自定义提示词”下方新增开关，允许用户手动开启或关闭术语提取功能。

### 翻译器内核升级
- **OpenAI/Gemini (纯文本版) 升级**：内核全面升级，支持加载 HQ System Prompt，支持 JSON 格式交互，以及术语提取功能。现在非 HQ 版本也能享受部分高级特性。

### 超分模型
- **新增 MangaJaNai 超分模型**：支持 x2、x4、DAT2 x4 三种模式，共 17 个模型
- **模型自动选择**：根据图片分辨率自动选择最佳模型（1200p-2048p）
- **切割逻辑统一**：与 RealCUGAN 保持一致（overlap=16, tile_size=400）

### 文本过滤
- **新增文本过滤列表功能**：支持自定义过滤不需要翻译的文本
- **过滤开关**：可在配置中启用或禁用文本过滤功能

### API配置管理
- **新增预设管理功能**：支持为不同翻译器创建独立的API配置预设，新建预设时创建空白配置，避免配置互相干扰
- **新增API测试功能**：在API密钥输入框旁添加"测试"按钮，可测试连接并验证模型是否可用（支持OpenAI、Gemini、Sakura）
- **新增获取模型列表功能**：在模型输入框旁添加"获取模型"按钮，从API实时获取可用模型列表并自动填充
- **Gemini第三方API支持**：Gemini翻译器支持使用OpenAI兼容的第三方代理服务

## ⚡ 优化

### 模型下载
- **移除 manga-ocr 库依赖**：使用内置的 `InternalMangaOcr` 实现，直接基于 transformers 库，无需安装 manga-ocr 包
- **添加 ModelScope 备用下载地址**：所有 65 个模型文件都添加了魔搭社区（ModelScope）作为备用下载源，提高国内用户下载成功率
- **下载速度监控**：新增下载速度检测功能，每 10 秒检查一次下载速度，如果低于 100 KB/s 自动切换到备用链接
- **自动故障转移**：当 GitHub 下载失败或速度过慢时，自动切换到 ModelScope 镜像下载

### 翻译流程
- **Prompt 格式统一**：统一了 HQ 和非 HQ 翻译器的 Prompt 构建逻辑，确保行为一致。
- **Prompt 文件修复**：修复了提示词文件生成时的 JSON 语法错误问题。
- **质量检查策略调整**：禁用了容易误判的“可疑符号”和“空翻译”检查，减少不必要的重试，提高翻译成功率。

### 翻译器
- **JSON 格式请求**：翻译器发送的请求改为 JSON 格式，提高解析准确性
- **JSON 响应解析**：支持解析 JSON 数组格式的翻译结果，兼容纯文本格式
- **调试日志优化**：翻译器原始响应日志改为 debug 级别

### 配置文件
- **配置读取鲁棒性增强**：改进配置文件读取逻辑，提高容错能力
- **upscale_ratio 字段扩展**：支持字符串类型（如 "x2", "x4", "DAT2 x4"）

### 日志系统
- **日志队列限制优化**：限制日志队列和缓冲区大小，避免日志过多导致内存占用过高和界面卡顿
  - 日志队列限制为 1000 条
  - 日志框最大显示 5000 行，超出自动清理旧日志
  - 日志缓冲区达到 200 条时自动刷新

### 代码规范
- **datetime 使用规范化**：所有时间相关代码改用 `datetime.now(timezone.utc)` 替代已弃用的 `datetime.utcnow()`，符合 Python 3.12+ 最佳实践

## 🐛 修复

### 模型下载
- **下载验证增强**：添加 SHA256 哈希验证，检测下载失败的文件（< 1KB）
- **模型迁移**：自动迁移旧目录的模型文件到新目录

### Inpainting 修复
- **ONNX Runtime 内存优化**：移除可能导致内存碎片化的配置，优化内存管理
- **内存释放优化**：ONNX 推理后及时释放临时变量并强制垃圾回收
- **新增"强制使用PyTorch"选项**：用户可在设置中启用，跳过 ONNX 直接使用 PyTorch，避免内存问题
- **改进错误提示**：启动时检查备用模型，ONNX 失败时给出清晰的降级提示
- **修复参数传递**：修复 `ModelWrapper.load` 方法的参数传递问题

### 文本渲染修复
- **修复竖排内横排匹配问题**：修复省略号（`...`）被错误识别为英文单词而横排显示的问题，从正则表达式中移除点号匹配
- **修复翻译导入颜色丢失**：修复从 JSON 导入翻译数据时，字体颜色和描边颜色可能因解析问题而丢失的问题

### Qt界面修复
- **修复译文列表编辑后导出不生效的问题**：修复在"可编辑译文"列表中编辑译文后，点击"应用所有译文更改"按钮，导出图片时译文未更新的bug。问题原因是批量更新译文时只更新了Model数据，未同步到ResourceManager，导出时获取到旧数据

### 编码问题修复
- **修复 UTF-16-LE 解码错误**：在 `common.py` 中新增 `sanitize_text_encoding()` 统一编码清理函数，自动检测并修复 UTF-16-LE/UTF-16-BE 编码问题，清理损坏字符、空字节和不可见控制字符。已在所有翻译器（OpenAI/Gemini/HQ版本）中集成，解决 `'utf-16-le' codec can't decode byte 0x03 in position 1220: truncated data` 错误

## 📦 依赖

- 新增 `spandrel==0.4.1` 依赖，用于加载 DAT2 模型